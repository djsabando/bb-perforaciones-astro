---
/** items: [{ type: 'video'|'image', src: string, poster?: string, alt?: string, caption?: string }] */

type MediaItem = {
  type: 'video' | 'image';
  src: string;
  poster?: string;
  alt?: string;
  caption?: string;
};

interface Props {
  items?: MediaItem[];   // opcional si a veces no pasas items
  title?: string;
  subtitle?: string;
}

const items = Astro.props.items ?? [
  // Ejemplos:
  { type: 'video', src: '/media/test-1.mp4', poster: '/media/test-1.jpg', caption: 'Testimonio 1' },
  { type: 'image', src: '/img/galeria/pozo-01.jpg', alt: 'Pozo agr√≠cola', caption: 'Pozo agr√≠cola ‚Äî 120 m, 18 l/s' },
  { type: 'video', src: '/media/test-2.mp4', poster: '/media/test-2.jpg', caption: 'Testimonio 2' },
  { type: 'image', src: '/img/galeria/pozo-02.jpg', alt: 'Pozo industrial', caption: 'Pozo industrial ‚Äî 80 m, 12 l/s' },
];
// const {
//   items = [],
//   title = 'Galer√≠a',
//   subtitle = 'Proyectos recientes con resultados medibles.',
// } = Astro.props as Props;
---

<section id="galeria" class="section bg-gray-50">
  <div class="mx-auto max-w-6xl px-6">
    <h2 class="section-title">Galer√≠a</h2>
    <p class="section-sub">Proyectos recientes con resultados medibles.</p>


    <div class="relative mt-8" tabindex="-1">
      <!-- SCROLLER -->
      <div class="carousel overflow-x-auto snap-x snap-mandatory scroll-smooth no-scrollbar">
        <ul class="flex gap-3 md:gap-5 lg:gap-6">
        <!-- <ul class="flex gap-6"> -->
          {items.map((it) => (
            <li class="snap-start shrink-0 w-[65vw] sm:w-[260px] md:w-[280px] lg:w-[280px] xl:w-[280px]">
                
              <figure class="relative rounded-2xl overflow-hidden bg-black aspect-[9/16]">
                {it.type === 'video' ? (
                  <video
                    preload="none"
                    playsinline
                    muted
                    controls={false}
                    poster={it.poster}
                    class="h-full w-full object-cover"
                  >
                    <source src={it.src} type="video/mp4" />
                  </video>
                ) : (
                  <img
                    src={it.src}
                    alt={it.alt ?? ''}
                    loading="lazy"
                    class="h-full w-full object-cover"
                  />
                )}

                <!-- Overlay play/pause (se oculta al reproducir) -->
                <button
                  class="playbtn absolute inset-0 grid place-content-center transition-opacity duration-200"
                  aria-label="Reproducir / pausar"
                >
                  <span class="grid place-items-center h-14 w-14 rounded-full bg-black/60 backdrop-blur-md ring-1 ring-white/30">
                    <svg viewBox="0 0 24 24" class="h-6 w-6 text-white" aria-hidden="true">
                      <path d="M8 5v14l11-7z" fill="currentColor" />
                    </svg>
                  </span>
                </button>
              </figure>

              {it.caption && (
                <figcaption class="mt-3 text-sm text-gray-600">
                  {it.caption}
                </figcaption>
              )}
            </li>
          ))}
        </ul>
      </div>

      <!-- FLECHAS -->
      <div class="pointer-events-none absolute -bottom-16 right-0 hidden md:flex gap-3">
        <button type="button" class="prev pointer-events-auto h-10 w-10 rounded-full border bg-white/90 hover:bg-white grid place-items-center shadow" aria-label="Anterior">
          <svg viewBox="0 0 24 24" class="h-5 w-5"><path d="M15 6l-6 6 6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <button type="button" class="next pointer-events-auto h-10 w-10 rounded-full border bg-white/90 hover:bg-white grid place-items-center shadow" aria-label="Siguiente">
          <svg viewBox="0 0 24 24" class="h-5 w-5"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
  </div>
</section>

<style is:global>
  .no-scrollbar::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ scrollbar-width: none; }
</style>

<script>
(() => {
  const scriptEl = /** @type {HTMLScriptElement | null} */ (document.currentScript);
  const root = scriptEl?.closest('section');
  if (!root) return;

  const scroller = root.querySelector<HTMLElement>('.carousel');
  const list = scroller?.querySelector<HTMLUListElement>('ul');
  const cards = list ? (Array.from(list.children) as HTMLElement[]) : [];
  const prev = root.querySelector<HTMLButtonElement>('.prev');
  const next = root.querySelector<HTMLButtonElement>('.next');

  if (!scroller || !list || cards.length === 0) return;

  // üîí Desde aqu√≠ TS sabe que NO son null
  const scrollerEl: HTMLElement = scroller;
  const listEl: HTMLUListElement = list;

  const getGap = () => {
    const styles = getComputedStyle(listEl);
    const raw = (styles.columnGap || styles.gap || '24').toString();
    const n = parseFloat(raw);
    return Number.isFinite(n) ? n : 24;
  };

  const getCardW = () => cards[0]?.getBoundingClientRect().width ?? 360;

  function scrollByDir(dir: number) {
    scrollerEl.scrollBy({ left: dir * (getCardW() + getGap()), behavior: 'smooth' });
    (root as HTMLElement).focus();
  }

  prev?.addEventListener('click', () => scrollByDir(-1));
  next?.addEventListener('click', () => scrollByDir(1));

  // Overlay play/pause
  root.querySelectorAll<HTMLButtonElement>('.playbtn').forEach((btn) => {
    const fig = btn.closest('figure') as HTMLElement | null;
    const video = fig?.querySelector<HTMLVideoElement>('video') ?? null;

    if (!video) { btn.classList.add('hidden'); return; }

    const hide = () => btn.classList.add('!opacity-0');
    const show = () => btn.classList.remove('!opacity-0');

    btn.addEventListener('click', () => {
      if (video.paused) {
        root.querySelectorAll<HTMLVideoElement>('video').forEach((v) => {
          if (v !== video) {
            v.pause();
            v.closest('figure')?.querySelector<HTMLButtonElement>('.playbtn')
              ?.classList.remove('!opacity-0');
          }
        });
        video.muted = false;
        void video.play();
        hide();
      } else {
        video.pause();
        show();
      }
    });

    video.addEventListener('pause', show);
    video.addEventListener('ended', show);
  });

  // Teclado
  root.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
      e.preventDefault();
      scrollByDir(e.key === 'ArrowRight' ? 1 : -1);
    }
  });
})();
</script>
